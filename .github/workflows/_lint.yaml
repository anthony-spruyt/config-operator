---
# yaml-language-server: $schema=https://raw.githubusercontent.com/SchemaStore/schemastore/master/src/schemas/json/github-workflow.json
name: Lint

on:
  workflow_call:

jobs:
  lint:
    name: MegaLinter
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-lint-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: Checkout
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98
        with:
          fetch-depth: 0

      - name: Run MegaLinter
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_ALL_CODEBASE: ${{ github.event_name != 'pull_request' }}
        run: ./lint.sh --ci

      - name: Upload SARIF to GitHub Security
        if: (success() || failure()) && hashFiles('megalinter-reports/megalinter-report.sarif') != ''
        continue-on-error: true
        id: sarif-upload
        uses: github/codeql-action/upload-sarif@b2ff80ddacba59b60f4e0cf3b699baaea3230cd9
        with:
          sarif_file: megalinter-reports/megalinter-report.sarif

      - name: SARIF upload status
        if: steps.sarif-upload.outcome == 'failure'
        run: |
          echo "::notice::SARIF upload failed (check security-events: write permission)"
          {
            echo "## Code Scanning"
            echo ""
            echo "> **Note:** SARIF upload failed. Ensure \`security-events: write\` permission is set."
          } >> "$GITHUB_STEP_SUMMARY"
